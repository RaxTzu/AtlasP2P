# ============================================
# PRODUCTION OVERRIDES
# ============================================
# Single entry point via Caddy reverse proxy.
# Auto-SSL with Let's Encrypt.
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#   make prod
#
# Exposed Ports:
#   80  - HTTP (redirects to HTTPS)
#   443 - HTTPS (Caddy with auto-SSL)
#
# Required Environment Variables:
#   DOMAIN - Your domain (e.g., nodes.example.com)
#   ACME_EMAIL - Email for Let's Encrypt (e.g., admin@example.com)
# ============================================

services:
  # ===========================================
  # REVERSE PROXY (Single Entry Point)
  # ===========================================
  caddy:
    image: caddy:2-alpine
    container_name: atlasp2p-caddy
    ports:
      - "80:80"
      - "443:443"
    environment:
      - DOMAIN=${DOMAIN:-localhost}
      - ACME_EMAIL=${ACME_EMAIL:-admin@localhost}
    volumes:
      - ./docker/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      - web
      - kong
    restart: unless-stopped

  # Production web app (no exposed ports, Caddy proxies)
  web:
    build:
      target: production
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - WEB_TARGET=production
      # In production, browser calls same origin, proxied by Caddy
      - NEXT_PUBLIC_SUPABASE_URL=https://${DOMAIN:-localhost}/supabase

  # Override auth for production URLs
  auth:
    environment:
      API_EXTERNAL_URL: https://${DOMAIN:-localhost}/supabase
      GOTRUE_SITE_URL: https://${DOMAIN:-localhost}
      GOTRUE_URI_ALLOW_LIST: https://${DOMAIN:-localhost}
      # Use real SMTP in production
      GOTRUE_MAILER_AUTOCONFIRM: "false"
      GOTRUE_SMTP_HOST: ${SMTP_HOST}
      GOTRUE_SMTP_PORT: ${SMTP_PORT:-587}
      GOTRUE_SMTP_USER: ${SMTP_USER}
      GOTRUE_SMTP_PASS: ${SMTP_PASS}

  # Crawler for production
  crawler:
    build:
      context: .
      dockerfile: Dockerfile.crawler
    container_name: atlasp2p-crawler
    env_file:
      - .env
    environment:
      # Production-specific overrides
      - NEXT_PUBLIC_SUPABASE_URL=https://${DOMAIN:-localhost}/supabase
    volumes:
      - ./data/geoip:/app/data/geoip:ro
    restart: unless-stopped
    profiles:
      - crawler

volumes:
  caddy-data:
  caddy-config:
